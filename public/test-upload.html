<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: #e8ecff;
        }
        .upload-area.dragover {
            background: #d0d9ff;
            border-color: #4458ca;
        }
        input[type="file"] {
            display: none;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #333;
        }
        .log-error {
            color: #f44;
        }
        .log-success {
            color: #4f4;
        }
        .log-info {
            color: #44f;
        }
        .log-warning {
            color: #fa0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .control-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        input[type="text"], input[type="password"] {
            padding: 5px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</h1>
        
        <div class="controls">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <div class="control-group">
                <label>API URL:</label>
                <input type="text" id="apiUrl" value="" placeholder="–ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ">
                <button onclick="detectApiUrl()">–ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button>
            </div>
            <div class="control-group">
                <label>–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="username" value="admin">
            </div>
            <div class="control-group">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" value="admin123">
            </div>
            <button onclick="testLogin()">1. –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
            <button onclick="testApi()">2. –¢–µ—Å—Ç API</button>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <h3>üìÅ –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel —Ñ–∞–π–ª</h3>
            <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: .xlsx, .xls</p>
            <button onclick="document.getElementById('fileInput').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        </div>
        
        <div class="status" id="status" style="display: none;"></div>
        
        <div class="controls">
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <button onclick="testUpload()">3. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞</button>
            <button onclick="createTestFile()">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π Excel</button>
        </div>
        
        <div class="log" id="log">
            <div class="log-entry log-info">üöÄ –ö–æ–Ω—Å–æ–ª—å –æ—Ç–ª–∞–¥–∫–∏ –≥–æ—Ç–æ–≤–∞</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        let token = null;
        let selectedFile = null;
        let apiUrl = window.location.origin;
        
        // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL
        function detectApiUrl() {
            apiUrl = window.location.origin;
            document.getElementById('apiUrl').value = apiUrl;
            log('info', `API URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${apiUrl}`);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        detectApiUrl();
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(type, message, data = null) {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const time = new Date().toLocaleTimeString();
            let content = `[${time}] ${message}`;
            
            if (data) {
                content += '\n' + JSON.stringify(data, null, 2);
            }
            
            entry.textContent = content;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            
            // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å
            console.log(`[${type.toUpperCase()}]`, message, data || '');
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="log-entry log-info">üöÄ –õ–æ–≥ –æ—á–∏—â–µ–Ω</div>';
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }
        
        // –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            log('info', 'üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            log('info', `URL: ${apiUrl}/api/auth/login`);
            
            try {
                const response = await fetch(`${apiUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                log('info', `–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    token = data.token;
                    log('success', '‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', {
                        user: data.user,
                        tokenLength: token.length
                    });
                    showStatus('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Ç–µ—Å—Ç–æ–≤
                    localStorage.setItem('test_token', token);
                } else {
                    log('error', '‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', data);
                    showStatus('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                }
            } catch (error) {
                log('error', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', error.message);
                showStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            }
        }
        
        // –¢–µ—Å—Ç API
        async function testApi() {
            if (!token) {
                log('warning', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                return;
            }
            
            log('info', 'üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API endpoints...');
            
            // –¢–µ—Å—Ç /api/files/test
            try {
                const response = await fetch(`${apiUrl}/api/files/test`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('success', '‚úÖ Files API —Ä–∞–±–æ—Ç–∞–µ—Ç', data);
                } else {
                    log('error', `‚ùå Files API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${response.status}`);
                }
            } catch (error) {
                log('error', '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Files API', error.message);
            }
            
            // –¢–µ—Å—Ç /api/database/info
            try {
                const response = await fetch(`${apiUrl}/api/database/info`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('success', '‚úÖ Database API —Ä–∞–±–æ—Ç–∞–µ—Ç', data);
                } else {
                    log('error', `‚ùå Database API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${response.status}`);
                }
            } catch (error) {
                log('error', '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Database API', error.message);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        document.getElementById('fileInput').addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                log('info', `üìÑ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ${selectedFile.name}`, {
                    size: `${(selectedFile.size / 1024).toFixed(2)} KB`,
                    type: selectedFile.type
                });
            }
        });
        
        // Drag & Drop
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            selectedFile = e.dataTransfer.files[0];
            if (selectedFile) {
                log('info', `üìÑ –§–∞–π–ª –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ drag&drop: ${selectedFile.name}`);
            }
        });
        
        // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏
        async function testUpload() {
            if (!token) {
                log('warning', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                return;
            }
            
            if (!selectedFile) {
                log('warning', '‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
                return;
            }
            
            log('info', 'üì§ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞...');
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º XMLHttpRequest –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    log('info', `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${percent.toFixed(2)}%`);
                }
            });
            
            xhr.addEventListener('load', () => {
                log('info', `–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω. –°—Ç–∞—Ç—É—Å: ${xhr.status}`);
                
                try {
                    const response = JSON.parse(xhr.responseText);
                    
                    if (xhr.status >= 200 && xhr.status < 300) {
                        log('success', '‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!', response);
                        showStatus('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!', 'success');
                    } else {
                        log('error', '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', response);
                        showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', 'error');
                    }
                } catch (e) {
                    log('error', '‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞', xhr.responseText);
                }
            });
            
            xhr.addEventListener('error', () => {
                log('error', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
                showStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            });
            
            xhr.addEventListener('timeout', () => {
                log('error', '‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏');
                showStatus('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è', 'error');
            });
            
            xhr.open('POST', `${apiUrl}/api/files/upload`);
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
            xhr.timeout = 300000; // 5 –º–∏–Ω—É—Ç
            
            log('info', '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...');
            xhr.send(formData);
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ Excel —Ñ–∞–π–ª–∞
        function createTestFile() {
            log('info', 'üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ Excel —Ñ–∞–π–ª–∞...');
            
            const data = [
                ['–ù–æ–º–µ—Ä', '–ö–æ–¥', '–¢–æ–≤–∞—Ä', '–í–∞—Ä–∏–∞–Ω—Ç', '–¢–∏–ø –æ–ø–ª–∞—Ç—ã', '–ö–æ–ª-–≤–æ', '–ï–¥.', '–¶–µ–Ω–∞', '–°–∫–∏–¥–∫–∞%', '–°–∫–∏–¥–∫–∞', '–°—É–º–º–∞', '–í—Ä–µ–º—è', '–î–∞—Ç–∞', '–ö–∞—Å—Å–∏—Ä'],
                ['001', 'P001', '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä 1', '–°—Ç–∞–Ω–¥–∞—Ä—Ç', '–ù–∞–ª–∏—á–Ω—ã–µ', 2, '—à—Ç', 100, 0, 0, 200, '10:00', '2024-01-15', '–ò–≤–∞–Ω–æ–≤'],
                ['002', 'P002', '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä 2', '–ë–æ–ª—å—à–æ–π', 'QR', 1, '—à—Ç', 150, 10, 15, 135, '11:30', '2024-01-15', '–ü–µ—Ç—Ä–æ–≤'],
                ['003', 'P003', '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä 3', '–ú–∞–ª–µ–Ω—å–∫–∏–π', '–ö–∞—Ä—Ç–∞', 3, '—à—Ç', 50, 0, 0, 150, '14:20', '2024-01-16', '–°–∏–¥–æ—Ä–æ–≤']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–î–∞–Ω–Ω—ã–µ');
            
            XLSX.writeFile(wb, 'test_data.xlsx');
            log('success', '‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: test_data.xlsx');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏–∑ localStorage
        const savedToken = localStorage.getItem('test_token');
        if (savedToken) {
            token = savedToken;
            log('info', 'üîë –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω');
        }
    </script>
</body>
</html>
